# è”é‚¦å­¦ä¹ å¯è§†åŒ–ç³»ç»Ÿ - è½¯ä»¶å·¥ç¨‹åŒ–è¯´æ˜æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºFlaskçš„è”é‚¦å­¦ä¹ å¯è§†åŒ–ç³»ç»Ÿï¼Œä¸»è¦ç”¨äºLUNA16è‚ºç»“èŠ‚æ£€æµ‹çš„åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ã€‚ç³»ç»Ÿé‡‡ç”¨å¤šç§è½¯ä»¶å·¥ç¨‹åŒ–æ‰‹æ®µï¼Œå®ç°äº†è‡ªåŠ¨åŒ–ã€åä½œåŒ–çš„å¼€å‘å’Œéƒ¨ç½²æµç¨‹ã€‚

---

## 1. è‡ªåŠ¨åŒ–å·¥ç¨‹å®è·µ

### 1.1 ä¾èµ–ç®¡ç†è‡ªåŠ¨åŒ–

**å®æ–½æ‰‹æ®µï¼š**
- ä½¿ç”¨ `requirements.txt` ç»Ÿä¸€ç®¡ç†é¡¹ç›®ä¾èµ–
- åŒ…å«54ä¸ªæ˜ç¡®ç‰ˆæœ¬çš„ä¾èµ–åŒ…
- æ”¯æŒ `pip install -r requirements.txt` ä¸€é”®å®‰è£…

**æŠ€æœ¯æ ˆï¼š**
```
Flask==3.0.3                  # Webæ¡†æ¶
flask_socketio==5.5.1         # å®æ—¶é€šä¿¡
torch==2.6.0                  # æ·±åº¦å­¦ä¹ æ¡†æ¶
numpy==1.26.4                 # æ•°å€¼è®¡ç®—
pandas==2.2.2                 # æ•°æ®å¤„ç†
simpleitk==2.5.0              # åŒ»å­¦å›¾åƒå¤„ç†
supabase==2.15.2              # äº‘æ•°æ®åº“
```

### 1.2 é…ç½®ç®¡ç†è‡ªåŠ¨åŒ–

**å®æ–½æ‰‹æ®µï¼š**
- ä½¿ç”¨ `.env` æ–‡ä»¶ç®¡ç†ç¯å¢ƒé…ç½®
- è‡ªåŠ¨æ£€æµ‹å’ŒåŠ è½½ç¯å¢ƒå˜é‡
- æ”¯æŒæœ¬åœ°å­˜å‚¨å’Œäº‘å­˜å‚¨çš„è‡ªåŠ¨åˆ‡æ¢

```python
# è‡ªåŠ¨åŒ–é…ç½®åŠ è½½
load_dotenv()
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_KEY")

# è‡ªåŠ¨é™çº§æœºåˆ¶
if SUPABASE_URL and SUPABASE_KEY:
    supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
else:
    print("ğŸ”„ å°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ç”¨")
    SUPABASE_AVAILABLE = False
```

### 1.3 è®­ç»ƒæµç¨‹è‡ªåŠ¨åŒ–

**å®æ–½æ‰‹æ®µï¼š**
- è‡ªåŠ¨åŒ–è”é‚¦å­¦ä¹ è®­ç»ƒæµç¨‹
- è‡ªåŠ¨æ¨¡å‹èšåˆå’Œåˆ†å‘
- è‡ªåŠ¨ç”Ÿæˆè®­ç»ƒå†å²å’Œå¯è§†åŒ–å›¾è¡¨

**æ ¸å¿ƒç»„ä»¶ï¼š**
- `FederatedServer`: è‡ªåŠ¨å¤„ç†æ¨¡å‹èšåˆ
- `FederatedClient`: è‡ªåŠ¨æ‰§è¡Œæœ¬åœ°è®­ç»ƒ
- `FederatedLearningCoordinator`: åè°ƒæ•´ä¸ªè®­ç»ƒæµç¨‹

### 1.4 æ•°æ®å¤„ç†è‡ªåŠ¨åŒ–

**å®æ–½æ‰‹æ®µï¼š**
- è‡ªåŠ¨åŒ»å­¦å›¾åƒé¢„å¤„ç†
- è‡ªåŠ¨æ•°æ®åˆ†ç‰‡å’Œåˆ†å¸ƒ
- è‡ªåŠ¨ç”Ÿæˆè®­ç»ƒæ•°æ®é›†

```python
class FederatedLearningCoordinator:
    def distribute_data_automatically(self, data_path):
        """è‡ªåŠ¨åˆ†å‘æ•°æ®åˆ°å„ä¸ªå®¢æˆ·ç«¯"""
        # è‡ªåŠ¨æ‰«ææ•°æ®æ–‡ä»¶
        # è‡ªåŠ¨åˆ†ç‰‡å’Œåˆ†å¸ƒ
        # è‡ªåŠ¨éªŒè¯æ•°æ®å®Œæ•´æ€§
```

---

## 2. åä½œåŒ–å·¥ç¨‹å®è·µ

### 2.1 æ¨¡å—åŒ–æ¶æ„è®¾è®¡

**å®æ–½æ‰‹æ®µï¼š**
- é‡‡ç”¨MVCæ¶æ„æ¨¡å¼
- æ˜ç¡®çš„ä»£ç åˆ†å±‚å’ŒèŒè´£åˆ†ç¦»
- æ¨¡å—åŒ–çš„ç»„ä»¶è®¾è®¡

**ç›®å½•ç»“æ„ï¼š**
```
code/
â”œâ”€â”€ app.py                    # ä¸»åº”ç”¨å…¥å£
â”œâ”€â”€ src/                      # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ federated_training.py # è”é‚¦å­¦ä¹ è®­ç»ƒ
â”‚   â”œâ”€â”€ federated_inference.py # è”é‚¦æ¨ç†
â”‚   â”œâ”€â”€ federated_inference_utils.py # æ¨ç†å·¥å…·
â”‚   â””â”€â”€ simple_inference.py   # ç®€å•æ¨ç†
â”œâ”€â”€ templates/                # å‰ç«¯æ¨¡æ¿
â”œâ”€â”€ static/                   # é™æ€èµ„æº
â”‚   â”œâ”€â”€ css/                  # æ ·å¼æ–‡ä»¶
â”‚   â”œâ”€â”€ js/                   # JavaScriptæ–‡ä»¶
â”‚   â””â”€â”€ training_images/      # è®­ç»ƒå›¾åƒ
â””â”€â”€ models/                   # æ¨¡å‹å­˜å‚¨
```

### 2.2 å®æ—¶åä½œæœºåˆ¶

**å®æ–½æ‰‹æ®µï¼š**
- åŸºäºWebSocketçš„å®æ—¶é€šä¿¡
- å¤šç”¨æˆ·åä½œç•Œé¢
- å®æ—¶çŠ¶æ€åŒæ­¥

```javascript
// å®æ—¶åä½œåŠŸèƒ½
function initializeSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('WebSocket è¿æ¥æˆåŠŸ');
        updateConnectionStatus(true);
        socket.emit('request_status_update');
    });
    
    socket.on('user_status_update', function(data) {
        updateUserStatus(data);
    });
}
```

### 2.3 ç”¨æˆ·ç®¡ç†å’Œæƒé™æ§åˆ¶

**å®æ–½æ‰‹æ®µï¼š**
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸åŒæƒé™
- å®‰å…¨çš„ç”¨æˆ·è®¤è¯æœºåˆ¶

```python
# ç”¨æˆ·è§’è‰²ç®¡ç†
@app.route("/server_dashboard")
def server_dashboard():
    if "username" not in session or session.get("role") != "server":
        return redirect(url_for("login"))
    # æœåŠ¡ç«¯ä¸“ç”¨åŠŸèƒ½

@app.route("/client_dashboard")
def client_dashboard():
    if "username" not in session or session.get("role") != "client":
        return redirect(url_for("login"))
    # å®¢æˆ·ç«¯ä¸“ç”¨åŠŸèƒ½
```

### 2.4 æ•°æ®æŒä¹…åŒ–å’Œå…±äº«

**å®æ–½æ‰‹æ®µï¼š**
- JSONæ ¼å¼çš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨
- è®­ç»ƒå†å²çš„æŒä¹…åŒ–ç®¡ç†
- å¤šå®¢æˆ·ç«¯æ•°æ®å…±äº«æœºåˆ¶

```python
def save_training_history(history_data):
    """ä¿å­˜è®­ç»ƒå†å²æ•°æ®åˆ°JSONæ–‡ä»¶"""
    history_file = "./training_history.json"
    with open(history_file, "w", encoding="utf-8") as f:
        json.dump(history_data, f, indent=2, ensure_ascii=False)
```

---

## 3. è´¨é‡ä¿è¯å·¥ç¨‹å®è·µ

### 3.1 é”™è¯¯å¤„ç†å’Œå¼‚å¸¸ç®¡ç†

**å®æ–½æ‰‹æ®µï¼š**
- å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è‡ªåŠ¨é”™è¯¯æ¢å¤
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

```python
try:
    supabase = create_client(SUPABASE_URL, SUPABASE_KEY)
    print("âœ… Supabaseè¿æ¥æˆåŠŸ")
except Exception as e:
    print(f"âš ï¸ Supabaseè¿æ¥å¤±è´¥: {e}")
    print("ğŸ”„ å°†ä½¿ç”¨æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ç”¨")
    SUPABASE_AVAILABLE = False
```

### 3.2 ä»£ç æ–‡æ¡£åŒ–

**å®æ–½æ‰‹æ®µï¼š**
- è¯¦ç»†çš„ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£å­—ç¬¦ä¸²
- æ¨¡å—åŠŸèƒ½è¯´æ˜
- APIæ¥å£æ–‡æ¡£

```python
"""
è”é‚¦å­¦ä¹ è®­ç»ƒç³»ç»Ÿ - LUNA16è‚ºç»“èŠ‚æ£€æµ‹
ä½¿ç”¨FedAvgç®—æ³•è¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒ

ä¸»è¦ç»„ä»¶:
1. FederatedServer: è”é‚¦æœåŠ¡å™¨ï¼Œè´Ÿè´£æ¨¡å‹èšåˆ
2. FederatedClient: è”é‚¦å®¢æˆ·ç«¯ï¼Œè´Ÿè´£æœ¬åœ°è®­ç»ƒ
3. FedAvgç®—æ³•å®ç°
4. æ•°æ®åˆ†ç‰‡å’Œåˆ†å¸ƒ
"""
```

### 3.3 å…¼å®¹æ€§è®¾è®¡

**å®æ–½æ‰‹æ®µï¼š**
- è·¨å¹³å°å…¼å®¹æ€§ï¼ˆå¯åœ¨ç”µè„‘ç«¯å’Œç§»åŠ¨ç«¯ä½¿ç”¨ï¼‰
- å¤šæµè§ˆå™¨æ”¯æŒï¼ˆç»æµ‹è¯•
- å‘åå…¼å®¹çš„APIè®¾è®¡
---

## 4. éƒ¨ç½²å’Œè¿ç»´è‡ªåŠ¨åŒ–


### 4.1 äº‘æœåŠ¡é›†æˆ

**å®æ–½æ‰‹æ®µï¼š**
- Supabaseäº‘æ•°æ®åº“é›†æˆï¼Œæ‰€æœ‰çš„è´¦å·å¯†ç éƒ½ä½¿ç”¨å¯†æ–‡å­˜å‚¨ã€‚

### 4.2 ç›‘æ§å’Œæ—¥å¿—

**å®æ–½æ‰‹æ®µï¼š**
- WebSocketè¿æ¥çŠ¶æ€ç›‘æ§ï¼ˆåœ¨ç”¨æˆ·ç«¯å¯ä»¥æŸ¥çœ‹åœ¨çº¿äººæ•°ä»¥åŠæœåŠ¡ç«¯æ˜¯å¦åœ¨çº¿ï¼ŒæœåŠ¡ç«¯å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªç”¨æˆ·ç«¯çš„åœ¨çº¿æƒ…å†µï¼‰
- ç”¨æˆ·æ´»åŠ¨è·Ÿè¸ªï¼ˆåœ¨æœåŠ¡ç«¯å¯ä»¥å®æ—¶çœ‹åˆ°æ¯ä¸€ä¸ªç”¨æˆ·çš„æ–‡ä»¶ä¸Šä¼ æƒ…å†µï¼‰
- è®­ç»ƒè¿‡ç¨‹ç›‘æ§ï¼ˆè®­ç»ƒæ—¶æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å¯ä»¥å®æ—¶æŸ¥çœ‹å½“å‰çš„è®­ç»ƒæƒ…å†µï¼‰

```javascript
// è¿æ¥çŠ¶æ€ç›‘æ§
socket.on('disconnect', function() {
    console.log('WebSocket è¿æ¥æ–­å¼€');
    updateConnectionStatus(false);
    // è‡ªåŠ¨é‡è¿æœºåˆ¶
    if (reconnectAttempts < maxReconnectAttempts) {
        setTimeout(() => {
            reconnectAttempts++;
            console.log(`å°è¯•é‡è¿... (${reconnectAttempts}/${maxReconnectAttempts})`);
            socket.connect();
        }, 2000 * reconnectAttempts);
    }
});
```
---

## 5. é‡‡ç”¨çš„è½¯ä»¶å·¥ç¨‹åŒ–å·¥å…·å’ŒæŠ€æœ¯

### 5.1 å¼€å‘æ¡†æ¶å’Œåº“
- **Flask**: Webåº”ç”¨æ¡†æ¶
- **SocketIO**: å®æ—¶é€šä¿¡
- **PyTorch**: æ·±åº¦å­¦ä¹ æ¡†æ¶
- **SimpleITK**: åŒ»å­¦å›¾åƒå¤„ç†

### 5.2 æ•°æ®ç®¡ç†
- **JSON**: ç»“æ„åŒ–æ•°æ®å­˜å‚¨
- **Supabase**: äº‘æ•°æ®åº“æœåŠ¡
- **pandas**: æ•°æ®å¤„ç†å’Œåˆ†æ

### 5.3 å‰ç«¯æŠ€æœ¯
- **JavaScript ES6+**: ç°ä»£å‰ç«¯å¼€å‘
- **WebSocket**: å®æ—¶é€šä¿¡
- **CSS3**: å“åº”å¼è®¾è®¡

### 5.4 éƒ¨ç½²å’Œè¿ç»´
- **gunicorn**: WSGIæœåŠ¡å™¨
- **dotenv**: ç¯å¢ƒå˜é‡ç®¡ç†
- **bcrypt**: å¯†ç åŠ å¯†