<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>联邦学习服务器仪表盘</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/server_dashboard.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/server_training_chart.css') }}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-server"></i>联邦学习服务器控制台</h1>
        <div class="header-actions">
            <a href="{{ url_for('server_history') }}" class="history-btn">
                <i class="fas fa-history"></i>训练历史
            </a>
            <a href="{{ url_for('logout') }}" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>登出
            </a>
        </div>
    </div>

    <div class="container">
        <!-- 训练状态 -->
        <div class="card training-status">
            <div class="card-header">
                <i class="fas fa-chart-line"></i>
                <h2>训练状态</h2>
                <span id="refreshIndicator" class="refresh-indicator" style="display: none;">
                    <i class="fas fa-sync"></i>
                </span>
                <!-- 添加连接状态指示器 -->
                <div id="connectionStatus" class="connection-status">
                    <span class="status-dot" id="connectionDot"></span>
                    <span id="connectionText">连接中...</span>
                </div>
            </div>
            
            <div class="status-grid">
                <div class="status-item">
                    <h3 id="trainingStatus">
                        <span class="status-indicator" id="statusIndicator"></span>
                        待机
                    </h3>
                    <p>训练状态</p>
                </div>
                <div class="status-item">
                    <h3 id="currentRound">0/0</h3>
                    <p>当前轮次</p>
                </div>
                <div class="status-item">
                    <h3 id="activeClients">{{ training_status.active_clients }}</h3>
                    <p>活跃客户端</p>
                </div>
                <div class="status-item">
                    <h3 id="trainingProgress">0%</h3>
                    <p>训练进度</p>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: {{ training_status.progress }}%"></div>
            </div>

            <!-- 训练参数控制 -->
            <div class="training-parameters">
                <h3>训练参数设置</h3>
                <div class="parameter-grid">
                    <div class="parameter-control">
                        <label for="globalRounds">全局训练轮数</label>
                        <div class="param-controls">
                            <button class="param-btn" onclick="adjustParam('global', -1)">-</button>
                            <span id="globalRounds" class="param-value">5</span>
                            <button class="param-btn" onclick="adjustParam('global', 1)">+</button>
                        </div>
                        <div class="param-range">
                            <small>范围: 1-20轮</small>
                        </div>
                    </div>
                    <div class="parameter-control">
                        <label for="localEpochs">本地训练轮数</label>
                        <div class="param-controls">
                            <button class="param-btn" onclick="adjustParam('local', -1)">-</button>
                            <span id="localEpochs" class="param-value">2</span>
                            <button class="param-btn" onclick="adjustParam('local', 1)">+</button>
                        </div>
                        <div class="param-range">
                            <small>范围: 1-10轮</small>
                        </div>
                    </div>
                </div>
                <div class="estimated-time">
                    <i class="fas fa-clock"></i>
                    <span>预计训练时间: <span id="estimatedTime">约 10-15 分钟</span></span>
                </div>
            </div>

            <div class="training-controls">
                <button id="startTrainingBtn" class="btn-primary" onclick="startFederatedTraining()">
                    <i class="fas fa-play"></i>
                    开始联邦学习训练
                </button>
                
                <!-- 推理按钮 - 只有在训练完成后才显示 -->
                <button id="inferenceBtn" class="btn-secondary" onclick="scrollToInference()" style="display: none; margin-left: 10px;">
                    <i class="fas fa-brain"></i>
                    模型推理
                </button>
            </div>
        </div>

        

        <!-- 服务器日志 -->
        <div class="card-clients">
            <div class="card-header">
                <i class="fas fa-clipboard-list"></i>
                <h2>服务器日志</h2>
            </div>
            <div class="log-container" id="serverLogs">
                <div class="log-entry">等待日志信息...</div>
            </div>
        </div>

        <!-- 训练日志 -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-brain"></i>
                <h2>训练日志</h2>
            </div>
            <div class="log-container" id="trainingLogs">
                <div class="log-entry">等待训练开始...</div>
            </div>
        </div>


        <!-- 实时训练损失监控 -->
        <div class="card training-visualization">
            <div class="card-header">
                <i class="fas fa-chart-line"></i>
                <h2>实时训练损失监控</h2>
                <div class="chart-controls">
                    <button id="exportServerDataBtn" class="btn-export" onclick="exportServerTrainingData()">
                        <i class="fas fa-download"></i>导出数据
                    </button>
                    <button id="resetServerChartsBtn" class="btn-reset" onclick="resetServerCharts()">
                        <i class="fas fa-refresh"></i>重置图表
                    </button>
                </div>
            </div>
            
            <div class="training-charts-container">
                <!-- 服务器聚合损失图表 -->
                <div class="chart-section">
                    <h3><i class="fas fa-server"></i>服务器聚合损失</h3>
                    <div class="chart-wrapper">
                        <canvas id="serverAggregatedChart"></canvas>
                    </div>
                    <div class="chart-metrics">
                        <div class="metric-card">
                            <span class="metric-label">当前轮次</span>
                            <span class="metric-value" id="serverCurrentRound">-</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">平均损失</span>
                            <span class="metric-value" id="serverAverageLoss">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 训练状态指示器 -->
            <div class="training-status-indicator">
                <div id="serverTrainingStatus" class="status-badge status-waiting">
                    <i class="fas fa-clock"></i>等待训练开始
                </div>
            </div>
        </div>

        
        <!-- 客户端状态 -->
        <div class="card-clients">
            <div class="card-header">
                <i class="fas fa-users"></i>
                <h2>客户端状态</h2>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>客户端</th>
                        <th>状态</th>
                        <th>最后登录</th>
                        <th>文件数</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr>
                        <td><i class="fas fa-user"></i> {{ client.username }}</td>
                        <td>
                            {% if client.file_uploaded %}
                                <span class="status-badge status-uploaded">已上传</span>
                            {% else %}
                                <span class="status-badge status-not-uploaded">未上传</span>
                            {% endif %}
                        </td>
                        <td>{{ client.last_login }}</td>
                        <td>{{ client.file_count }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #718096;">没有客户端数据</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 推理功能 -->
        <div class="card-infer">
            <div class="card-header">
                <i class="fas fa-brain"></i>
                <h2>模型推理</h2>
            </div>
            
            <div class="inference-section">
                <div class="inference-controls">
                    <div class="inference-upload">
                        <h4><i class="fas fa-upload"></i> 上传推理文件</h4>
                        
                        <!-- 拖拽上传区域 -->
                        <div class="upload-zone" onclick="document.getElementById('inferenceFileInput').click()" 
                             ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">
                            <div class="upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">点击或拖拽文件到此处上传</div>
                            <div class="upload-hint">请同时上传一组.mhd和.raw文件（支持多文件选择）</div>
                        </div>
                        
                        <input type="file" id="inferenceFileInput" accept=".mhd,.raw" multiple style="display: none;" onchange="handleInferenceFileUpload(event)">
                    
                        
                        <!-- 上传进度显示 -->
                        <div class="upload-progress" id="uploadProgress">
                            <h5><i class="fas fa-hourglass-half"></i> 上传进度</h5>
                            <div id="uploadProgressList"></div>
                        </div>
                    </div>
                    
                    <div class="inference-options">
                        <h4><i class="fas fa-cogs"></i> 推理选项</h4>
                        <div class="option-group">
                            <label>
                                <input type="radio" name="inferenceMode" value="federated" checked>
                                <span>联邦模型推理</span><br>
                                <small style="color: #718096;">使用训练完成的联邦模型</small>
                            </label>
                        </div>
                        <label>
                            <input type="checkbox" id="fastModeCheckbox">
                            <span>启用快速推理</span><br>
                            <small style="color: #718096;">减少计算时间，可能影响精度或无法识别</small>
                        </label>
                    </div>
                </div>

                <div class="inference-file-list" id="inferenceFileList">
                    <p style="color: #718096; text-align: center;">暂无上传的推理文件</p>
                </div>

                <div class="inference-status" id="inferenceStatus">
                    <div>
                        <i class="fas fa-spinner fa-spin"></i>
                        <span id="inferenceStatusText">正在等待文件上传...</span>
                    </div>
                    <div class="inference-progress">
                        <div class="inference-progress-fill" id="inferenceProgressBar" style="width: 0%"></div>
                    </div>
                    <div id="inferenceProgressText">0%</div>
                </div>

                <div style="text-align: center; margin: 1.5rem 0;">
                    <button id="runInferenceBtn" class="btn-primary" onclick="runInference()" disabled>
                        <i class="fas fa-brain"></i> 开始推理
                    </button>
                    <button class="btn-primary" onclick="clearAllFiles()">
                        <i class="fas fa-trash-alt"></i> 清空文件
                    </button>
                </div>

                <div class="inference-result" id="inferenceResult" style="display: none;">
                    <h4><i class="fas fa-chart-bar"></i> 推理结果</h4>
                    <img id="resultImage" src="" alt="推理结果" style="display: none;">
                    <p id="resultText" style="color: #718096;"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // WebSocket 连接
        let socket = null;
        let isTraining = {{ training_status.is_training | tojson }};
        let updateInterval;
        let lastDataChangeTimestamp = null; // 跟踪数据变化时间戳

        // 初始化 WebSocket 连接
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                console.log('WebSocket 连接成功');
                showNotification('实时连接已建立', 'success');
                
                // 请求状态更新
                socket.emit('request_status_update');
            });

            socket.on('disconnect', function() {
                console.log('WebSocket 连接断开');
                showNotification('实时连接断开，正在重连...', 'warning');
            });

            socket.on('user_status_update', function(data) {
                updateOnlineUsers(data);
            });

            socket.on('client_data_update', function(data) {
                updateClientTable(data);
            });

            socket.on('training_status_update', function(data) {
                updateTrainingStatus(data);
            });

            socket.on('logs_update', function(data) {
                if (data.type === 'server') {
                    updateServerLogs(data.logs);
                } else if (data.type === 'training') {
                    updateTrainingLogs(data.logs);
                }
            });

            // 定期请求日志更新
            setInterval(() => {
                if (socket && socket.connected) {
                    socket.emit('request_logs', {type: 'server'});
                    socket.emit('request_logs', {type: 'training'});
                }
            }, 5000);
        }

        // 更新在线用户显示
        function updateOnlineUsers(data) {
            console.log('在线用户更新:', data);
            
            const onlineUsersContainer = document.getElementById('onlineUsers');
            const onlineCountElement = document.getElementById('onlineCount');
            const connectionDot = document.getElementById('connectionDot');
            const connectionText = document.getElementById('connectionText');
            
            // 更新连接状态指示器
            if (connectionDot && connectionText) {
                connectionDot.className = 'status-dot online';
                connectionText.textContent = '实时连接';
            }
            
            if (!onlineUsersContainer || !onlineCountElement) return;
            
            const totalOnline = (data.online_clients || []).length + (data.online_servers || []).length;
            onlineCountElement.textContent = totalOnline;
            
            if (totalOnline === 0) {
                onlineUsersContainer.innerHTML = '<div class="no-users">没有在线用户</div>';
                return;
            }
            
            let usersHTML = '';
            
            // 显示在线服务器用户
            if (data.online_servers && data.online_servers.length > 0) {
                data.online_servers.forEach(server => {
                    usersHTML += `
                        <div class="online-user server-user">
                            <div class="user-icon">
                                <i class="fas fa-server"></i>
                            </div>
                            <div class="user-info">
                                <span class="username">${server.username}</span>
                                <span class="role">服务器</span>
                                <span class="connection-time">${server.connected_at}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            // 显示在线客户端用户
            if (data.online_clients && data.online_clients.length > 0) {
                data.online_clients.forEach(client => {
                    const uploadedIcon = client.uploaded ? 
                        '<i class="fas fa-check-circle" style="color: #28a745;"></i>' : 
                        '<i class="fas fa-times-circle" style="color: #dc3545;"></i>';
                    
                    usersHTML += `
                        <div class="online-user client-user">
                            <div class="user-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-info">
                                <span class="username">${client.username}</span>
                                <span class="role">客户端</span>
                                <span class="upload-status">${uploadedIcon} ${client.file_count} 文件</span>
                                <span class="connection-time">${client.connected_at}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            onlineUsersContainer.innerHTML = usersHTML;
        }

        // 更新客户端表格
        function updateClientTable(data) {
            const tbody = document.querySelector('.client-table tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            
            if (data.clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">没有客户端数据</td></tr>';
                return;
            }

            data.clients.forEach(client => {
                const row = document.createElement('tr');
                const statusIcon = client.is_online ? 
                    '<i class="fas fa-circle" style="color: #28a745;"></i>' : 
                    '<i class="fas fa-circle" style="color: #dc3545;"></i>';
                
                const uploadIcon = client.uploaded ? 
                    '<i class="fas fa-check-circle" style="color: #28a745;"></i>' : 
                    '<i class="fas fa-times-circle" style="color: #dc3545;"></i>';

                row.innerHTML = `
                    <td>${statusIcon} ${client.username}</td>
                    <td>${uploadIcon} ${client.uploaded ? '是' : '否'}</td>
                    <td>${client.upload_time}</td>
                    <td>${client.last_login}</td>
                    <td>${client.file_count}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 更新服务器日志
        function updateServerLogs(logs) {
            const logContainer = document.getElementById('serverLogs');
            if (!logContainer) return;

            logContainer.innerHTML = '';
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = log;
                logContainer.appendChild(logEntry);
            });
            
            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 更新训练日志
        function updateTrainingLogs(logs) {
            const logContainer = document.getElementById('trainingLogs');
            if (!logContainer) return;

            if (!logs || logs.length === 0) {
                // 当没有日志时显示默认消息
                logContainer.innerHTML = '<div class="log-entry">等待训练开始...</div>';
                return;
            }

            logContainer.innerHTML = '';
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = log;
                logContainer.appendChild(logEntry);
            });
            
            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateTrainingStatus(status) {
            const statusElement = document.getElementById('trainingStatus');
            const indicatorElement = document.getElementById('statusIndicator');
            const roundElement = document.getElementById('currentRound');
            const clientsElement = document.getElementById('activeClients');
            const progressElement = document.getElementById('trainingProgress');
            const progressBar = document.getElementById('progressBar');
            const startBtn = document.getElementById('startTrainingBtn');
            const inferenceBtn = document.getElementById('inferenceBtn');

            // 添加空值检查，防止元素不存在时出错
            if (!statusElement || !roundElement || !clientsElement || !progressElement || !progressBar || !startBtn || !inferenceBtn) {
                console.warn('某些DOM元素未找到，跳过状态更新');
                return;
            }

            if (status.is_training) {
                statusElement.innerHTML = '<span class="status-indicator status-active"></span>训练中';
                if (indicatorElement) {
                    indicatorElement.className = 'status-indicator status-active';
                }
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>训练进行中...';
                inferenceBtn.style.display = 'none'; // 训练时隐藏推理按钮
            } else {
                statusElement.innerHTML = '<span class="status-indicator status-inactive"></span>待机';
                if (indicatorElement) {
                    indicatorElement.className = 'status-indicator status-inactive';
                }
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i>开始联邦学习训练';
                
                // 如果训练已完成（进度100%），显示推理按钮
                if (status.progress === 100 && status.end_time) {
                    inferenceBtn.style.display = 'inline-block';
                }
            }

            roundElement.textContent = `${status.current_round}/${status.total_rounds}`;
            clientsElement.textContent = status.active_clients;
            progressElement.textContent = `${status.progress}%`;
            progressBar.style.width = `${status.progress}%`;
        }

        function updateLogs(serverLogs, trainingLogs) {
            const serverLogsContainer = document.getElementById('serverLogs');
            const trainingLogsContainer = document.getElementById('trainingLogs');
            
            let allServerLogs = [];
            let allTrainingLogs = [];

            // 添加服务器日志
            if (serverLogs && serverLogs.length > 0) {
                allServerLogs = [...serverLogs];
            }

            // 添加训练日志
            if (trainingLogs && trainingLogs.length > 0) {
                allTrainingLogs = [...trainingLogs];
            }

            // 去重并保持顺序
            allServerLogs = [...new Set(allServerLogs)];
            allTrainingLogs = [...new Set(allTrainingLogs)];

            // 显示服务器日志
            if (allServerLogs.length > 0) {
                serverLogsContainer.innerHTML = allServerLogs.map(log => 
                    `<div class="log-entry">${log}</div>`
                ).join('');
                serverLogsContainer.scrollTop = serverLogsContainer.scrollHeight;
            } else {
                // 服务器日志为空时显示默认消息
                serverLogsContainer.innerHTML = '<div class="log-entry">等待日志信息...</div>';
            }

            // 显示训练日志
            if (allTrainingLogs.length > 0) {
                trainingLogsContainer.innerHTML = allTrainingLogs.map(log => 
                    `<div class="log-entry">${log}</div>`
                ).join('');
                trainingLogsContainer.scrollTop = trainingLogsContainer.scrollHeight;
            } else {
                // 训练日志为空时显示默认消息
                trainingLogsContainer.innerHTML = '<div class="log-entry">等待训练开始...</div>';
            }
        }

        async function fetchStatus() {
            try {
                document.getElementById('refreshIndicator').style.display = 'inline-block';
                const response = await fetch('/api/server/status');
                const data = await response.json();
                
                console.log('获取状态数据:', data);
                
                updateTrainingStatus(data.training_status);
                updateClientStatus(data.client_count, data.total_clients);
                updateLogs(data.server_logs, data.training_logs);
                
                // 检查数据变化，如果有新数据上传，则刷新页面
                if (data.data_change_timestamp && 
                    lastDataChangeTimestamp && 
                    data.data_change_timestamp !== lastDataChangeTimestamp) {
                    console.log('检测到新数据上传，刷新页面');
                    showNotification('检测到新数据上传，页面将自动刷新', 'info');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000); // 2秒后刷新页面
                }
                lastDataChangeTimestamp = data.data_change_timestamp;
                
                // 检查训练状态变化
                const wasTraining = isTraining;
                isTraining = data.training_status.is_training;
                
                // 如果训练刚刚结束
                if (wasTraining && !isTraining) {
                    showNotification('训练已完成！', 'success');
                    if (updateInterval) {
                        console.log('训练完成，停止状态轮询');
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                    
                    // 重新启用开始训练按钮
                    const startBtn = document.getElementById('startTrainingBtn');
                    if (startBtn) {
                        startBtn.disabled = false;
                        startBtn.innerHTML = '<i class="fas fa-play"></i>开始联邦学习训练';
                    }
                }
                
                // 如果训练刚刚开始，确保轮询正在进行
                if (!wasTraining && isTraining && !updateInterval) {
                    console.log('检测到训练开始，启动状态轮询');
                    updateInterval = setInterval(fetchStatus, 3000); // 更频繁的更新
                }
                
            } catch (error) {
                console.error('获取状态失败:', error);
            } finally {
                document.getElementById('refreshIndicator').style.display = 'none';
            }
        }

        function updateClientStatus(clientCount, totalClients) {
            // 更新活跃客户端数量显示
            const activeClientsElement = document.getElementById('activeClients');
            if (activeClientsElement) {
                activeClientsElement.textContent = `${clientCount}`;
            }
            const clientCountElements = document.querySelectorAll('.client-count');
            if (clientCountElements) {
                clientCountElements.textContent = `${clientCount}`;
            }
        }

        // 训练参数控制函数
        let globalRounds = 5;
        let localEpochs = 2;

        function adjustParam(type, change) {
            if (type === 'global') {
                const newValue = globalRounds + change;
                if (newValue >= 1 && newValue <= 20) {
                    globalRounds = newValue;
                    document.getElementById('globalRounds').textContent = globalRounds;
                }
                
                // 更新按钮状态 - 使用更精确的选择器
                const globalControls = document.querySelector('.parameter-control:first-child .param-controls');
                const decreaseBtn = globalControls.querySelector('.param-btn:first-child');
                const increaseBtn = globalControls.querySelector('.param-btn:last-child');
                decreaseBtn.disabled = globalRounds <= 1;
                increaseBtn.disabled = globalRounds >= 20;
                
            } else if (type === 'local') {
                const newValue = localEpochs + change;
                if (newValue >= 1 && newValue <= 10) {
                    localEpochs = newValue;
                    document.getElementById('localEpochs').textContent = localEpochs;
                }
                
                // 更新按钮状态 - 使用更精确的选择器
                const localControls = document.querySelector('.parameter-control:last-child .param-controls');
                const decreaseBtn = localControls.querySelector('.param-btn:first-child');
                const increaseBtn = localControls.querySelector('.param-btn:last-child');
                decreaseBtn.disabled = localEpochs <= 1;
                increaseBtn.disabled = localEpochs >= 10;
            }
            
            // 更新预计时间
            updateEstimatedTime();
        }

        function updateEstimatedTime() {
            // 简单的时间估算逻辑：每个全局轮次大约2-3分钟，本地轮数会影响每轮时间
            const baseTimePerRound = 2; // 基础时间（分钟）
            const localEpochFactor = localEpochs * 0.5; // 本地轮数影响因子
            const totalMinutes = globalRounds * (baseTimePerRound + localEpochFactor);
            
            let timeText;
            if (totalMinutes < 60) {
                timeText = `约 ${Math.round(totalMinutes)} 分钟`;
            } else {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = Math.round(totalMinutes % 60);
                timeText = `约 ${hours} 小时 ${minutes} 分钟`;
            }
            
            document.getElementById('estimatedTime').textContent = timeText;
        }

        async function startFederatedTraining() {
            try {
                const startBtn = document.getElementById('startTrainingBtn');
                startBtn.disabled = true;
                startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>正在启动...';
                
                // 准备训练参数
                const trainingParams = {
                    global_rounds: globalRounds,
                    local_epochs: localEpochs
                };
                
                const response = await fetch('/server/start_training', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(trainingParams)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message, 'success');
                    
                    // 清除现有的轮询（如果有）
                    if (updateInterval) {
                        clearInterval(updateInterval);
                    }
                    
                    // 开始实时更新（更频繁）
                    updateInterval = setInterval(fetchStatus, 3000);
                    console.log('训练启动成功，开始状态轮询');
                    
                    // 立即获取一次状态
                    setTimeout(fetchStatus, 500); // 稍微延迟以确保服务器状态已更新
                } else {
                    showNotification(result.error || '启动训练失败', 'error');
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play"></i>开始联邦学习训练';
                }
            } catch (error) {
                showNotification('请求错误: ' + error.message, 'error');
                document.getElementById('startTrainingBtn').disabled = false;
                document.getElementById('startTrainingBtn').innerHTML = '<i class="fas fa-play"></i>开始联邦学习训练';
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置初始状态
            updateTrainingStatus({{ training_status | tojson }});
            
            // 初始化训练参数控制
            updateEstimatedTime();
            adjustParam('global', 0); // 初始化按钮状态
            adjustParam('local', 0);  // 初始化按钮状态
            
            // 如果已经在训练，开始轮询
            if (isTraining) {
                updateInterval = setInterval(fetchStatus, 5000);
                fetchStatus(); // 立即获取一次
            }

            // 初始化推理功能
            loadInferenceFiles();
        });

        // 推理功能相关JavaScript
        let selectedInferenceFile = null;
        let inferenceStatusInterval = null;

        // 处理推理文件上传
        async function handleInferenceFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            showUploadProgress();
            const formData = new FormData();
            
            // 添加所有文件到FormData
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
                addUploadProgressItem(files[i].name, 'uploading');
            }

            try {
                const response = await fetch('/api/server/upload_inference_file', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(result.message, 'success');
                    loadInferenceFiles(); // 重新加载文件列表
                    
                    // 更新上传进度
                    if (result.uploaded_files) {
                        result.uploaded_files.forEach(filename => {
                            updateUploadProgressItem(filename, 'success');
                        });
                    }
                    
                    if (result.errors && result.errors.length > 0) {
                        result.errors.forEach(error => {
                            showNotification(error, 'warning');
                        });
                    }
                } else {
                    showNotification(result.error || '文件上传失败', 'error');
                    // 将所有文件标记为失败
                    for (let i = 0; i < files.length; i++) {
                        updateUploadProgressItem(files[i].name, 'error');
                    }
                }
            } catch (error) {
                showNotification('上传错误: ' + error.message, 'error');
                // 将所有文件标记为失败
                for (let i = 0; i < files.length; i++) {
                    updateUploadProgressItem(files[i].name, 'error');
                }
            }

            // 清空文件输入
            event.target.value = '';
            
            // 3秒后隐藏上传进度
            setTimeout(hideUploadProgress, 3000);
        }

        // 加载推理文件列表
        async function loadInferenceFiles() {
            try {
                const response = await fetch('/api/server/list_inference_files');
                const result = await response.json();

                // 缓存文件列表数据
                window.currentFileList = result.files || [];

                const fileList = document.getElementById('inferenceFileList');
                
                if (result.files && result.files.length > 0) {
                    fileList.innerHTML = result.files.map(file => `
                        <div class="inference-file-item" onclick="selectInferenceFile('${file.name}', this)">
                            <div class="file-info">
                                <div class="file-name">
                                    <strong>${file.name}</strong>
                                    ${file.has_pair ? '<i class="fas fa-check-circle" style="color: #48bb78; margin-left: 8px;" title="文件对完整"></i>' : '<i class="fas fa-exclamation-triangle" style="color: #ed8936; margin-left: 8px;" title="缺少配对文件"></i>'}
                                </div>
                                <div class="file-details">
                                    <span>大小: ${(file.total_size / 1024 / 1024).toFixed(2)} MB</span>
                                    <span>上传时间: ${file.upload_time}</span>
                                    ${file.has_pair ? `<span>配对文件: ${file.raw_file}</span>` : '<span style="color: #ed8936;">缺少.raw文件</span>'}
                                </div>
                                <div class="file-status">
                                    <div class="status-indicator-small ${file.has_pair ? 'status-complete' : 'status-incomplete'}"></div>
                                    <span>${file.has_pair ? '文件对完整' : '文件对不完整'}</span>
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="btn-danger btn-small" onclick="event.stopPropagation(); deleteInferenceFile('${file.name}')" title="删除文件对">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <i class="file-type-icon fas fa-file-medical"></i>
                            </div>
                        </div>
                    `).join('');
                } else {
                    fileList.innerHTML = '<p style="color: #718096; text-align: center;">暂无上传的推理文件</p>';
                }
            } catch (error) {
                console.error('加载文件列表失败:', error);
            }
        }

        // 删除推理文件
        async function deleteInferenceFile(filename) {
            if (!confirm(`确定要删除文件对 "${filename}" 吗？这将同时删除对应的.raw文件。`)) {
                return;
            }

            try {
                const response = await fetch('/api/server/delete_inference_file', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filename: filename })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(result.message, 'success');
                    loadInferenceFiles(); // 重新加载文件列表
                    
                    // 如果删除的是当前选中的文件，清除选择
                    if (selectedInferenceFile === filename) {
                        selectedInferenceFile = null;
                        document.getElementById('runInferenceBtn').disabled = true;
                    }
                } else {
                    showNotification(result.error || '删除失败', 'error');
                }
            } catch (error) {
                showNotification('删除错误: ' + error.message, 'error');
            }
        }

        // 拖拽上传功能
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // 模拟文件输入
                const fileInput = document.getElementById('inferenceFileInput');
                fileInput.files = files;
                handleInferenceFileUpload({ target: fileInput });
            }
        }

        // 上传进度相关函数
        function showUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadProgressList').innerHTML = '';
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function addUploadProgressItem(filename, status) {
            const progressList = document.getElementById('uploadProgressList');
            const progressItem = document.createElement('div');
            progressItem.className = 'progress-item';
            progressItem.id = `progress-${filename}`;
            progressItem.innerHTML = `
                <div class="progress-filename">${filename}</div>
                <div class="progress-status ${status === 'success' ? 'progress-success' : status === 'error' ? 'progress-error' : ''}">
                    ${status === 'uploading' ? '<i class="fas fa-spinner fa-spin"></i> 上传中...' : 
                      status === 'success' ? '<i class="fas fa-check"></i> 成功' : 
                      status === 'error' ? '<i class="fas fa-times"></i> 失败' : status}
                </div>
            `;
            progressList.appendChild(progressItem);
        }

        function updateUploadProgressItem(filename, status) {
            const progressItem = document.getElementById(`progress-${filename}`);
            if (progressItem) {
                const statusElement = progressItem.querySelector('.progress-status');
                statusElement.className = `progress-status ${status === 'success' ? 'progress-success' : 'progress-error'}`;
                statusElement.innerHTML = status === 'success' ? '<i class="fas fa-check"></i> 成功' : '<i class="fas fa-times"></i> 失败';
            }
        }

        // 清空所有文件
        async function clearAllFiles() {
            if (!confirm('确定要删除所有推理文件吗？')) {
                return;
            }

            try {
                const response = await fetch('/api/server/list_inference_files');
                const result = await response.json();
                
                if (result.files && result.files.length > 0) {
                    for (const file of result.files) {
                        await deleteInferenceFile(file.name);
                    }
                }
            } catch (error) {
                showNotification('清空文件时出错: ' + error.message, 'error');
            }
        }

        // 刷新文件列表
        function refreshFileList() {
            showNotification('正在刷新文件列表...', 'info');
            loadInferenceFiles();
        }

        // 选择推理文件
        function selectInferenceFile(filename, element) {
            // 移除之前的选中状态
            document.querySelectorAll('.inference-file-item').forEach(item => {
                item.classList.remove('selected');
            });

            // 添加选中状态
            element.classList.add('selected');
            selectedInferenceFile = filename;

            // 检查文件对是否完整
            const fileData = getFileData(filename);
            if (fileData && fileData.has_pair) {
                // 启用运行按钮
                document.getElementById('runInferenceBtn').disabled = false;
                showNotification(`已选择文件: ${filename}`, 'info');
            } else {
                // 禁用运行按钮
                document.getElementById('runInferenceBtn').disabled = true;
                showNotification(`文件对不完整，无法进行推理: ${filename}`, 'warning');
            }
        }

        // 获取文件数据
        function getFileData(filename) {
            // 这里应该从最近一次加载的文件列表中获取数据
            // 为了简化，我们可以重新获取，但在实际应用中应该缓存这些数据
            return window.currentFileList ? window.currentFileList.find(f => f.name === filename) : null;
        }

        // 运行推理
        async function runInference() {
            if (!selectedInferenceFile) {
                showNotification('请先选择一个推理文件', 'error');
                return;
            }

            const inferenceMode = document.querySelector('input[name="inferenceMode"]:checked').value;
            const fastMode = document.getElementById('fastModeCheckbox').checked;

            const requestData = {
                filename: selectedInferenceFile,
                use_federated: inferenceMode === 'federated',
                fast_mode: fastMode
            };

            try {
                const response = await fetch('/api/server/run_inference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('推理已启动', 'success');
                    
                    // 显示推理状态面板
                    document.getElementById('inferenceStatus').style.display = 'block';
                    document.getElementById('runInferenceBtn').disabled = true;
                    
                    // 开始监控推理状态
                    inferenceStatusInterval = setInterval(checkInferenceStatus, 2000);
                    checkInferenceStatus(); // 立即检查一次
                    
                } else {
                    showNotification(result.error || '推理启动失败', 'error');
                }
            } catch (error) {
                showNotification('请求错误: ' + error.message, 'error');
            }
        }

        // 检查推理状态
        async function checkInferenceStatus() {
            try {
                const response = await fetch('/api/server/get_inference_status');
                const status = await response.json();

                updateInferenceStatus(status);

                // 如果推理完成，停止监控
                if (!status.is_running) {
                    if (inferenceStatusInterval) {
                        clearInterval(inferenceStatusInterval);
                        inferenceStatusInterval = null;
                    }

                    // 重新启用运行按钮
                    document.getElementById('runInferenceBtn').disabled = false;

                    // 如果有结果图像，显示它
                    if (status.result_image) {
                        displayInferenceResult(status.result_image);
                    }

                    // 如果有错误，显示错误信息
                    if (status.error) {
                        showNotification('推理失败: ' + status.error, 'error');
                        document.getElementById('inferenceStatus').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('获取推理状态失败:', error);
            }
        }

        // 更新推理状态显示
        function updateInferenceStatus(status) {
            const statusText = document.getElementById('inferenceStatusText');
            const progressBar = document.getElementById('inferenceProgressBar');
            const progressText = document.getElementById('inferenceProgressText');

            statusText.textContent = status.current_step || '推理中...';
            progressBar.style.width = status.progress + '%';
            progressText.textContent = status.progress + '%';

            // 如果推理完成，隐藏状态面板
            if (!status.is_running && status.progress === 100) {
                setTimeout(() => {
                    document.getElementById('inferenceStatus').style.display = 'none';
                }, 2000);
            }
        }

        // 显示推理结果
        function displayInferenceResult(imageData) {
            const resultDiv = document.getElementById('inferenceResult');
            const resultImage = document.getElementById('resultImage');
            const resultText = document.getElementById('resultText');

            resultImage.src = imageData;
            resultImage.style.display = 'block';
            resultText.textContent = '推理完成！点击图像可查看大图。';
            resultDiv.style.display = 'block';

            // 添加点击图像放大功能
            resultImage.onclick = function() {
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>推理结果 - ${selectedInferenceFile}</title>
                            <style>
                                body { 
                                    margin: 0; 
                                    padding: 20px; 
                                    background: #f0f0f0; 
                                    display: flex; 
                                    justify-content: center; 
                                    align-items: center; 
                                    min-height: 100vh;
                                }
                                img { 
                                    max-width: 100%; 
                                    height: auto; 
                                    border-radius: 8px; 
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                                }
                                h1 {
                                    position: fixed;
                                    top: 20px;
                                    left: 20px;
                                                                       color: #333;
                                    font-family: Arial, sans-serif;
                                }
                            </style>
                        </head>
                        <body>
                            <h1>推理结果: ${selectedInferenceFile}</h1>
                            <img src="${imageData}" alt="推理结果">
                        </body>
                    </html>
                `);
            };

            showNotification('推理完成！结果已显示在下方', 'success');
        }

        // 滚动到推理功能区域
        function scrollToInference() {
            const inferenceSection = document.querySelector('.card-infer h2').parentElement.parentElement;
            const cards = document.querySelectorAll('.card-infer');
            
            // 查找推理功能卡片
            for (let card of cards) {
                const header = card.querySelector('h2');
                if (header && header.textContent.includes('模型推理')) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // 添加高亮效果
                    card.style.border = '2px solid #667eea';
                    setTimeout(() => {
                        card.style.border = '';
                    }, 2000);
                    break;
                }
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            enhanceInferenceUI();
            
            if (isTraining) {
                updateInterval = setInterval(fetchAndUpdateStatus, 2000);
            }
        });
    </script>
    
    <!-- 服务器训练可视化 -->
    <script src="{{ url_for('static', filename='js/server_training_chart.js') }}"></script>
</body>
</html>
